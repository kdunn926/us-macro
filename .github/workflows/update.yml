name: Refresh Data and Publish

on:
  push:
    paths-ignore:
    # Changes to docs are autogenerated by this workflow
    - 'docs/**'
    - 'README.md'
  schedule:
    - cron:  '0 0 * * 6'

jobs:
  refreshAndPublish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v2

    - name: Cache Miniconda and dependencies
      uses: actions/cache@v1
      with:
        path: /usr/share/miniconda
        key: ${{ runner.OS }}-build-${{ hashFiles('**/requirements.txt') }}

    - name: Set up Python 3.6
      uses: actions/setup-python@v1
      with:
        python-version: '3.6'

    - name: Display system Python3 version
      run: |
        python3 -c 'import sys; print(sys.version)'
        echo "${{ steps.cache.outputs.cache-hit }}"
        pip install python-dateutil

    - name: Set up JDK 1.8 (for Tabula)
      uses: actions/setup-java@v1
      with:
        java-version: 1.8

    - name: Install dependencies
      run: |
        conda create --name ci
        conda activate ci
        conda install -c conda-forge --yes --file requirements.txt
        /usr/share/miniconda/bin/pip install yfinance
        /usr/share/miniconda/bin/pip install unidecode fake_useragent
        /usr/share/miniconda/bin/pip install git+https://github.com/abenassi/Google-Search-API
        rm -rf /usr/share/miniconda/lib/python*/site-packages/selenium*
        conda install -c conda-forge selenium==3.141.0 --force-reinstall

    - name: Update notebooks
      env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        find ./analysis/*.ipynb -exec \
          /usr/share/miniconda/bin/jupyter nbconvert \
            --ExecutePreprocessor.timeout=-1 \
            --to notebook --inplace \
            --execute {} \;
        git add ./analysis/*.ipynb

    - name: Commit updated notebooks
      run: |
        git config --local user.email 'action@github.com'
        git config --local user.name 'GitHub Action'
        git commit -m 'Add notebook execution changes'

    - name: Generate webpages
      run: |
        echo '::add-path::/usr/share/miniconda/bin'
        /usr/share/miniconda/bin/sos run release.sos clean
        /usr/share/miniconda/bin/sos run release.sos -s force
        git add ./docs

    - name: Commit generated webpages
      run: |
        git config --local user.email 'action@github.com'
        git config --local user.name 'GitHub Action'
        git commit -m 'Add generated page changes'

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
